<%- include("partials/head", { title: "‚öôÔ∏è Ustawienia" }) %>
<%- include("partials/header") %>

<div class="zu-settings">
  <main>
    <h2 class="section-title">
      <i class="bi bi-gear-fill"></i> Ustawienia systemu
    </h2>

    <form id="settingsForm" method="POST" action="/ustawienia" class="settings-panel">
      
      <!-- === Powiadomienie o zapisaniu === -->
      <div id="saveAlert" class="alert-box" style="display:none;">
        <i class="bi bi-check-circle-fill"></i> Zmiany zosta≈Çy zapisane pomy≈õlnie.
      </div>

      <!-- =====================================================
           üñåÔ∏è WYGLƒÑD
      ====================================================== -->
      <div class="settings-group">
        <h4><i class="bi bi-palette-fill"></i> WyglƒÖd</h4>

        <div class="setting-item">
          <label for="theme">Motyw aplikacji</label>
          <select id="theme" name="theme" class="form-select">
            <option value="dark"  <%= theme === 'dark' ? 'selected' : '' %>>Ciemny</option>
            <option value="light" <%= theme === 'light' ? 'selected' : '' %>>Jasny</option>
            <option value="auto"  <%= theme === 'auto' ? 'selected' : '' %>>Automatyczny</option>
          </select>
        </div>
      </div>


      <!-- =====================================================
           üë§ U≈ªYTKOWNIK
      ====================================================== -->
      <div class="settings-group">
        <h4><i class="bi bi-person-circle"></i> U≈ºytkownik</h4>

        <div class="setting-item">
          <label for="language">Jƒôzyk interfejsu</label>
          <select id="language" name="language" class="form-select">
            <option value="pl" <%= user.lang === 'pl' ? 'selected' : '' %>>Polski</option>
            <option value="en" <%= user.lang === 'en' ? 'selected' : '' %> disabled>English</option>
          </select>
        </div>
      </div>


      <!-- =====================================================
           ü™ü PASEK SYSTEMOWY (FOOTER)
      ====================================================== -->
      <div class="settings-group">
        <h4><i class="bi bi-window-stack"></i> Pasek systemowy</h4>

        <div class="setting-item">
          <label for="footerMode">Styl paska dolnego</label>
          <select id="footerMode" name="footerMode" class="form-select">
            <option value="icons"      <%= footer.mode === 'icons' ? 'selected' : '' %>>Tylko ikony</option>
            <option value="icons-text" <%= footer.mode === 'icons-text' ? 'selected' : '' %>>Ikony i tekst</option>
          </select>
        </div>

        <div class="setting-item">
          <label for="dateFormat">Format daty / zegara</label>
          <select id="dateFormat" name="dateFormat" class="form-select">
            <option value="horizontal" <%= footer.dateFormat === 'horizontal' ? 'selected' : '' %>>21 lis 2025 | 18:39</option>
            <option value="vertical"   <%= footer.dateFormat === 'vertical' ? 'selected' : '' %>>21 lis 2025 / 18:39</option>
          </select>
        </div>
      </div>


      <!-- =====================================================
           üîß SYSTEM
      ====================================================== -->
      <div class="settings-group">
        <h4><i class="bi bi-tools"></i> System</h4>

        <div class="setting-item form-switch">
          <label for="notifications">Powiadomienia systemowe</label>
          <input
            class="form-check-input"
            type="checkbox"
            id="notifications"
            name="notifications"
            <%= notifications ? "checked" : "" %>
            disabled
          />
        </div>

        <div class="setting-item form-switch">
          <label for="autoupdate">Automatyczne aktualizacje</label>
          <input
            class="form-check-input"
            type="checkbox"
            id="autoupdate"
            name="autoupdate"
            <%= autoupdate ? "checked" : "" %>
            disabled
          />
        </div>
      </div>

      <!-- === Przycisk zapisu === -->
      <div class="text-center mt-4">
        <button type="submit" class="btn-save">
          <i class="bi bi-save2"></i> Zapisz zmiany
        </button>
      </div>
    </form>
  </main>
</div>


<!-- =====================================================
     üü¶ AJAX zapis ustawie≈Ñ
====================================================== -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("settingsForm");
  const alertBox = document.getElementById("saveAlert");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const data = {};

    formData.forEach((value, key) => {
      data[key] = value;
    });

    // Checkboxy ‚Äî bo odznaczone nie lecƒÖ w FormData
    data.notifications = document.getElementById("notifications").checked;
    data.autoupdate = document.getElementById("autoupdate").checked;

    try {
      const res = await fetch("/ustawienia", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });

      if (res.ok) {
        // üîµ poka≈º alert "Zapisano"
        alertBox.style.display = "block";
        alertBox.classList.add("fade-in");

        // üîµ Dynamiczna zmiana motywu bez reloadu
        if (data.theme) {
          document.documentElement.setAttribute("data-theme", data.theme);
        }

        // üîµ AUTOMATYCZNE OD≈öWIE≈ªENIE STRONY
        setTimeout(() => {
          location.reload();
        }, 600); // 0.6 sek ‚Äî alert mignie, a potem reload

      } else {
        console.error("B≈ÇƒÖd zapisu ustawie≈Ñ:", res.status);
      }

    } catch (err) {
      console.error("‚ùå B≈ÇƒÖd:", err);
    }
  });
});
</script>

<%- include("partials/footer") %>
